# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1s1Z6mIsc8MnLQ45YN0ncOUYM3Ktlh82r
"""

import streamlit as st
import joblib
import pandas as pd
import numpy as np
import plotly.express as px
import os

# ================= PAGE CONFIG =================
st.set_page_config(
    page_title="Universal Churn Predictor",
    layout="wide",
    page_icon="ğŸ”®"
)

# ================= STYLE =================
st.markdown("""
<style>
.stMetric {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 16px;
    padding: 1rem;
    color: white;
}
</style>
""", unsafe_allow_html=True)

# ================= TITLE =================
st.title("ğŸ”® Universal Churn Predictor")
st.markdown("*Upload a dataset and instantly analyze churn risk*")

# ================= LOAD MODEL =================
@st.cache_resource
def load_model():
    return joblib.load("churn_model.pkl")

if not os.path.exists("churn_model.pkl"):
    st.error("âŒ `churn_model.pkl` not found.")
    st.stop()

model = load_model()
st.success("âœ… Model loaded")

# ================= FILE UPLOAD =================
uploaded_file = st.file_uploader("ğŸ“ Upload churn dataset (CSV)", type="csv")

if uploaded_file:
    df = pd.read_csv(uploaded_file)

    # ================= PREDICTION =================
    with st.spinner("ğŸ”® Running churn analysis..."):
        preds = model.predict(df)
        probs = model.predict_proba(df)[:, 1]

    df["Predicted_Churn"] = np.where(preds == 1, "ğŸ”´ High Risk", "ğŸŸ¢ Low Risk")
    df["Churn_Probability"] = probs

    # ================= METRICS =================
    total = len(df)
    high_risk = int(sum(preds))
    low_risk = total - high_risk

    col1, col2, col3, col4 = st.columns(4)
    col1.metric("ğŸ‘¥ Customers", total)
    col2.metric("ğŸ”´ High Risk", high_risk)
    col3.metric("ğŸŸ¢ Low Risk", low_risk)
    col4.metric("ğŸ“Š Avg Risk", f"{np.mean(probs) * 100:.1f}%")

    # ================= PIE CHART =================
    fig_pie = px.pie(
        values=[high_risk, low_risk],
        names=["High Risk", "Low Risk"],
        color_discrete_sequence=["#ff6b6b", "#4ecdc4"],
        title="Churn Risk Distribution"
    )
    st.plotly_chart(fig_pie, use_container_width=True)

    # ================= PROBABILITY DISTRIBUTION =================
    fig_hist = px.histogram(
        df,
        x="Churn_Probability",
        nbins=20,
        title="Churn Probability Distribution",
        color_discrete_sequence=["#667eea"]
    )
    st.plotly_chart(fig_hist, use_container_width=True)

    # ================= TOP HIGH-RISK CUSTOMERS =================
    st.markdown("### ğŸ”¥ Highest Risk Customers")
    st.dataframe(
        df.sort_values("Churn_Probability", ascending=False).head(20),
        use_container_width=True
    )

    # ================= DOWNLOAD =================
    st.download_button(
        "ğŸ’¾ Download Predictions",
        df.to_csv(index=False),
        "churn_analysis.csv"
    )

